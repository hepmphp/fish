<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>layim - layui</title>

<link rel="stylesheet" href="../build/css/layui.css">
<style>

</style>
</head>
<body>

<script src="../build/layui.js"></script>
<script src="../build/lay/lib/jquery.js"></script>
<script>

if(!/^http(s*):\/\//.test(location.href)){
  alert('请部署到localhost上查看该演示');
}

//建立WebSocket通讯
//注意：也可以直接采用 socket.io的版本，下面是以原生WS为例



layui.use(['layim'], function(layim){

  
  var autoReplay = [

  ];
  
  //基础配置
  layim.config({

    //初始化接口
    init: {
      url: './json/getList.json'
      ,data: {}
    }

    //简约模式（不显示主面板）
    //,brief: true

    //查看群员接口
    ,members: {
      url: './json/getMembers.json'
      ,data: {}
    }
    
    ,uploadImage: {
      url: '' //（返回的数据格式见下文）
      ,type: '' //默认post
    }

    ,uploadFile: {
      url: '' //（返回的数据格式见下文）
      ,type: '' //默认post
    }
    
    //,skin: ['aaa.jpg'] //新增皮肤
    //,isfriend: false //是否开启好友
    //,isgroup: false //是否开启群组
    //,min: true //是否始终最小化主面板（默认false）
    ,chatLog: './demo/chatlog.html' //聊天记录地址
    ,find: './demo/find.html'
  });
    window.layim = layim;
    var socket = new WebSocket('ws://127.0.0.1:9502');

//发送一个消息
// socket.send('Hi Server, I am LayIM!');

//更多情况下，一般是传递一个JSON
// socket.send(JSON.stringify({
//     type: '' //随便定义，用于在服务端区分消息类型
//     ,data: {}
// }));

//连接成功时触发
    socket.onopen = function(){
        console.log('onopen连接成功');
        socket.send('{"onopen":1,"from_username":"hepm"}');
    };

//监听收到的消息
    socket.onmessage = function(evt){
        //res为接受到的值，如 {"emit": "messageName", "data": {}}
        //emit即为发出的事件名，用于区分不同的消息
        let res = JSON.parse(evt.data);
        // console.log(res);
        var obj = {
            username: window.To.name
            ,avatar: window.To.avatar
            ,id: window.To.id
            ,type: window.To.type
            ,content: res.content
            ,timestamp: new Date().getTime()
        };
          layim.getMessage(obj);
    };


  //监听发送消息
  layim.on('sendMessage', function(data){
      window.To = data.to;
    console.log(data);
    var content = {
        "from_id": 1,
        "to_id": 2,
        "from_username": "hepm",
        "to_username": "fish",
        "type": 1,
        "status": 0,
        "content": "很好很强大2024-11-10 22:29:49",
        "group_id": 1,
        "send_time": 1731248989,
        "create_time": 1731248989
    };
    socket.send(JSON.stringify(content));


    //演示自动回复
    // setTimeout(function(){
    //   var obj = {};
    //   if(To.type === 'group'){
    //     obj = {
    //       username: '模拟群员'+(Math.random()*100|0)
    //       ,avatar: layui.cache.dir + 'images/face/'+ (Math.random()*72|0) + '.gif'
    //       ,id: To.id
    //       ,type: To.type
    //       ,content: autoReplay[Math.random()*9|0]
    //     }
    //   } else {
    //     obj = {
    //       username: To.name
    //       ,avatar: To.avatar
    //       ,id: To.id
    //       ,type: To.type
    //       ,content: autoReplay[Math.random()*9|0]
    //       ,timestamp: new Date().getTime()
    //     }
    //   }
    //   layim.getMessage(obj);
    // }, 1000);
  });

  //监听在线状态的切换事件
  layim.on('online', function(data){
    console.log(data);
  });

  //layim建立就绪
  layim.on('ready', function(res){
  
    //添加好友（如果检测到该socket）
    layim.addList({
      type: 'group'
      ,avatar: "http://tva3.sinaimg.cn/crop.64.106.361.361.50/7181dbb3jw8evfbtem8edj20ci0dpq3a.jpg"
      ,groupname: 'Angular开发'
      ,id: "12333333"
      ,members: 0
    });
    layim.addList({
      type: 'friend'
      ,avatar: "http://tp2.sinaimg.cn/2386568184/180/40050524279/0"
      ,username: '冲田杏梨'
      ,groupid: 2
      ,id: "1233333312121212"
      ,remark: ""
    });
    
    //接受消息（如果检测到该socket）
    setTimeout(function(){
      //不在好友列表，则为临时会话
      layim.getMessage({
        username: "Hi"
        ,avatar: "http://tva1.sinaimg.cn/crop.7.0.736.736.50/bd986d61jw8f5x8bqtp00j20ku0kgabx.jpg"
        ,id: "198909151014"
        ,type: "friend"
        ,content: "临时："+ new Date().getTime()
      });

      //在好友列表
      layim.getMessage({
        username: "贤心"
        ,avatar: "http://tp1.sinaimg.cn/1571889140/180/40030060651/1"
        ,id: "100001"
        ,type: "friend"
        ,content: "嗨，你好！欢迎体验LayIM。演示标记："+ new Date().getTime()
        ,timestamp: new Date().getTime()
      });
    }, 1000);
  });

  //监听查看群员
  layim.on('members', function(data){
    console.log(data);
  });
  
  //监听聊天窗口的切换
  layim.on('chatChange', function(data){
    console.log(data);
  });
});


</script>
</body>
</html>
